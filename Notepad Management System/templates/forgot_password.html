{% extends "base.html" %}
{% block content %}
<h2>Forgot Password</h2>

{% if not otp_stage %}
  <!-- Step 1: Request OTP -->
  <form method="post">
    <label>Username:</label>
    <input name="username" required>
    <button type="submit" name="action" value="request_otp">Request OTP</button>
  </form>
{% else %}
  <!-- Step 2: Verify OTP -->
  <form method="post">
    <label>Enter OTP:</label>
    <input name="otp" required>
    <button type="submit" name="action" value="verify_otp">Verify OTP</button>
  </form>

  {% if otp_expiry %}
    <p id="countdown" class="countdown-timer" data-expiry="{{ otp_expiry }}"></p>
  {% endif %}
{% endif %}

<style>
  .countdown-timer {
    font-weight: 600;
    color: #333;
    margin-top: 10px;
  }
  .countdown-timer.expired {
    color: red;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const el = document.getElementById('countdown');
    if (!el) return;

    const expiry = parseFloat(el.dataset.expiry) * 1000;
    if (isNaN(expiry)) return;

    function fmt(ms) {
      const total = Math.max(0, Math.floor(ms / 1000));
      const m = Math.floor(total / 60);
      const s = total % 60;
      return `${m}:${String(s).padStart(2, '0')}`;
    }

    function tick() {
      const now = Date.now();
      const remaining = expiry - now;
      if (remaining <= 0) {
        el.textContent = "OTP expired. Please request a new one.";
        el.classList.add('expired');
        clearInterval(timer);
      } else {
        el.textContent = `OTP expires in ${fmt(remaining)}`;
      }
    }

    tick();
    const timer = setInterval(tick, 1000);
  });
</script>

{% endblock %}
