{% extends "base.html" %}
{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
  <!-- SweetAlert2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block content %}
<h2>Your Notes</h2>

<div class="top-bar">
  <a href="{{ url_for('main.create_note') }}" class="add-note-btn">+ Add New Note</a>

  <form method="get" action="{{ url_for('main.home') }}" class="sort-form">
    <select name="sort_by" id="sort_by" onchange="this.form.submit()">
      <option value="date_desc" {% if sort_by == 'date_desc' %}selected{% endif %}>Newest First</option>
      <option value="date_asc" {% if sort_by == 'date_asc' %}selected{% endif %}>Oldest First</option>
      <option value="title_asc" {% if sort_by == 'title_asc' %}selected{% endif %}>Title (Aâ€“Z)</option>
      <option value="title_desc" {% if sort_by == 'title_desc' %}selected{% endif %}>Title (Zâ€“A)</option>
      <option value="updated_desc" {% if sort_by == 'updated_desc' %}selected{% endif %}>Last Modified</option>
    </select>
  </form>
</div>

{% if notes %}
  <div class="notes-grid">
    {% for n in notes %}
    <div class="note-card"
         data-title="{{ n['title'] }}"
         data-content="{{ n['content']|replace('\n', '<br>') }}"
         data-created="{{ n['created_at'] }}"
         data-modified="{{ n['updated_at'] or n['created_at'] }}">
      <h3>{{ n['title'] }}</h3>
      <p>{{ n['content'][:120] }}{% if n['content']|length > 120 %}...{% endif %}</p>

      <div class="note-actions">
        <a class="btn small" href="{{ url_for('main.edit_note', note_id=n['id']) }}">Edit</a>
        <form class="archive-form"
              action="{{ url_for('main.archive_note', note_id=n['id']) }}"
              method="post"
              style="display:inline">
          <button class="btn small archive" type="submit">Archive</button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
{% else %}
  <p>No notes yet.</p>
{% endif %}

<!-- ðŸªŸ Modal -->
<div class="modal-overlay"></div>
<div id="noteModal" class="modal">
  <button class="close-btn">&times;</button>
  <h2 id="modal-title"></h2>
  <p id="modal-content"></p>

  <div class="note-dates">
    <small>Created: <span id="modal-created"></span></small><br>
    <small>Modified: <span id="modal-modified"></span></small>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // SweetAlert2 archive confirmation
    document.querySelectorAll('.archive-form').forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        Swal.fire({
          title: 'Archive this note?',
          text: "You can restore it later from the archive.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, archive it',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            form.submit();
          }
        });
      });
    });

    // Modal setup
    const modal = document.getElementById('noteModal');
    const overlay = document.querySelector('.modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    const modalCreated = document.getElementById('modal-created');
    const modalModified = document.getElementById('modal-modified');
    const closeBtn = document.querySelector('.close-btn');

    // Format date to readable form
    function formatDate(dateString) {
      if (!dateString || dateString === 'N/A') return 'N/A';
      const d = new Date(dateString);
      if (isNaN(d)) return 'N/A';
      return d.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    document.querySelectorAll('.note-card').forEach(card => {
      card.addEventListener('click', e => {
        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('form')) return;

        modalTitle.innerHTML = card.dataset.title;
        modalContent.innerHTML = card.dataset.content;
        modalCreated.textContent = formatDate(card.dataset.created);
        modalModified.textContent = formatDate(card.dataset.modified);

        modal.style.display = 'block';
        overlay.style.display = 'block';
        document.body.style.overflow = 'auto';
      });
    });

    [closeBtn, overlay].forEach(el => {
      el.addEventListener('click', () => {
        modal.style.display = 'none';
        overlay.style.display = 'none';
      });
    });
  });
</script>
{% endblock %}
